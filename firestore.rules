rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    /**
     * Rooms collection
     * 
     * Security rules for interview rooms.
     * Only participants (creator or in participants array) can read.
     * Only authenticated users can create rooms.
     * Only creator can update room metadata.
     */
    match /rooms/{roomId} {
      // Helper function to check if user is a participant
      function isParticipant() {
        return request.auth != null && 
          (resource.data.createdBy == request.auth.uid || 
           request.auth.uid in resource.data.participants);
      }
      
      // Helper function to check if user is the creator
      function isCreator() {
        return request.auth != null && 
          resource.data.createdBy == request.auth.uid;
      }
      
      // Helper function to validate room document structure
      function isValidRoom() {
        return request.resource.data.keys().hasAll(['createdBy', 'participants', 'phase', 'status', 'createdAt', 'updatedAt']) &&
          request.resource.data.createdBy is string &&
          request.resource.data.participants is list &&
          request.resource.data.phase in ['waiting', 'tone', 'coding', 'reflection', 'ended'] &&
          request.resource.data.status in ['active', 'finished'];
      }
      
      // Read: Only participants can read room documents
      allow read: if request.auth != null && isParticipant();
      
      // Create: Only authenticated users can create rooms
      // Must set createdBy to their own UID
      allow create: if request.auth != null && 
        request.resource.data.createdBy == request.auth.uid &&
        isValidRoom();
      
      // Update: Only creator can update room metadata
      // Participants can be added by creator
      // Phase and status can be updated by creator
      allow update: if request.auth != null && 
        (isCreator() || 
         (request.auth.uid in resource.data.participants && 
          // Participants can only update their own presence (future: Liveblocks)
          // For now, only creator can update
          false));
      
      // Delete: Only creator can delete rooms
      allow delete: if request.auth != null && isCreator();
      
      /**
       * Reflections subcollection
       * 
       * Security rules for candidate reflection responses.
       * Candidates can write their own reflection, both participants can read.
       */
      match /reflections/{userId} {
        // Helper function to check if user is a participant in the parent room
        function isParticipantInRoom() {
          return request.auth != null && 
            (get(/databases/$(database)/documents/rooms/$(roomId)).data.createdBy == request.auth.uid || 
             request.auth.uid in get(/databases/$(database)/documents/rooms/$(roomId)).data.participants);
        }
        
        // Write: Candidate can write their own reflection
        allow write: if request.auth != null && 
          request.auth.uid == userId &&
          isParticipantInRoom();
        
        // Read: Both participants can read reflections
        allow read: if request.auth != null && isParticipantInRoom();
      }
      
      /**
       * Private Notes subcollection
       * 
       * Security rules for interviewer private notes.
       * Only interviewer (creator) can read/write their own notes.
       */
      match /privateNotes/{userId} {
        // Helper function to check if user is the creator (interviewer) of the parent room
        function isCreatorOfRoom() {
          return request.auth != null && 
            get(/databases/$(database)/documents/rooms/$(roomId)).data.createdBy == request.auth.uid;
        }
        
        // Read/Write: Only interviewer (creator) can read/write their own notes
        allow read, write: if request.auth != null && 
          request.auth.uid == userId &&
          isCreatorOfRoom();
      }
    }
    
    /**
     * Tasks collection
     * 
     * Security rules for task library.
     * All authenticated users can read tasks.
     * Only admins can create/update/delete tasks.
     */
    match /tasks/{taskId} {
      // Helper function to check if user is admin
      function isAdmin() {
        return request.auth != null && 
          exists(/databases/$(database)/documents/admins/$(request.auth.uid));
      }
      
      // Helper function to validate task document structure
      function isValidTask() {
        return request.resource.data.keys().hasAll(['title', 'description', 'difficulty', 'estimatedTime', 'language', 'createdAt', 'updatedAt', 'createdBy']) &&
          request.resource.data.title is string &&
          request.resource.data.description is string &&
          request.resource.data.difficulty in ['easy', 'medium', 'hard'] &&
          request.resource.data.estimatedTime is int &&
          request.resource.data.language in ['typescript', 'javascript', 'python', 'java'] &&
          request.resource.data.createdBy is string;
      }
      
      // Read: All authenticated users can read tasks
      allow read: if request.auth != null;
      
      // Create: Only admins can create tasks
      // Must set createdBy to their own UID
      allow create: if request.auth != null && 
        isAdmin() &&
        isValidTask() &&
        request.resource.data.createdBy == request.auth.uid;
      
      // Update: Only admins can update tasks
      allow update: if request.auth != null && 
        isAdmin() &&
        isValidTask();
      
      // Delete: Only admins can delete tasks
      allow delete: if request.auth != null && isAdmin();
    }
    
    /**
     * Admins collection
     * 
     * Security rules for admin access control.
     * Only existing admins can read the admin list.
     * Write operations are disabled (managed via Firebase Console).
     */
    match /admins/{userId} {
      // Helper function to check if user is admin
      function isAdmin() {
        return request.auth != null && 
          exists(/databases/$(database)/documents/admins/$(request.auth.uid));
      }
      
      // Read: Only admins can read admin list (for management)
      allow read: if request.auth != null && isAdmin();
      
      // Write: Disabled - admins are managed via Firebase Console
      allow write: if false;
    }
  }
}

